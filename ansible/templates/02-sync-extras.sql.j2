-- Add sync support to existing database
-- Generated by SMTP Master

-- Add tracking columns to virtual_domains
ALTER TABLE virtual_domains 
ADD COLUMN IF NOT EXISTS sync_id INT DEFAULT NULL,
ADD COLUMN IF NOT EXISTS last_sync DATETIME DEFAULT NULL;

-- Add tracking columns to virtual_users
ALTER TABLE virtual_users 
ADD COLUMN IF NOT EXISTS sync_id INT DEFAULT NULL,
ADD COLUMN IF NOT EXISTS last_sync DATETIME DEFAULT NULL;

-- Add tracking columns to virtual_aliases
ALTER TABLE virtual_aliases 
ADD COLUMN IF NOT EXISTS sync_id INT DEFAULT NULL,
ADD COLUMN IF NOT EXISTS last_sync DATETIME DEFAULT NULL;

-- Add tracking columns to dkim_keys
ALTER TABLE dkim_keys 
ADD COLUMN IF NOT EXISTS sync_id INT DEFAULT NULL,
ADD COLUMN IF NOT EXISTS last_sync DATETIME DEFAULT NULL;

-- Create sync log table to track changes
CREATE TABLE IF NOT EXISTS `sync_log` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `table_name` varchar(50) NOT NULL,
  `record_id` int(11) NOT NULL,
  `operation` enum('INSERT','UPDATE','DELETE') NOT NULL,
  `sync_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `synced` tinyint(1) NOT NULL DEFAULT 0,
  PRIMARY KEY (`id`),
  KEY `synced` (`synced`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Create a user for master server to connect with
CREATE USER IF NOT EXISTS 'mail_sync'@'%' IDENTIFIED BY '{{ vault_slave_db_password }}';
GRANT SELECT ON postfix.* TO 'mail_sync'@'%';
FLUSH PRIVILEGES;